<!DOCTYPE html><!--  This site was created in Webflow. https://www.webflow.com  -->
<!--  Last Published: Sat Oct 21 2023 12:42:03 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="63614076e9e25d20078c59de" data-wf-site="62fa1b7c943e1b195a14776d">
<head>
  <meta charset="utf-8">
  <title>Extend</title>
  <meta content="Extend" property="og:title">
  <meta content="Extend" property="twitter:title">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <meta content="Webflow" name="generator">
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <link href="../css/webflow.css" rel="stylesheet" type="text/css">
  <link href="../css/katydid-3d74ff.webflow.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
  <script type="text/javascript">WebFont.load({  google: {    families: ["IBM Plex Mono:100,200,300,regular,500,600,700","Noto Sans:200,300,regular,500,600,700,800"]  }});</script>
  <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
  <link href="../images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="../images/webclip.png" rel="apple-touch-icon">
  <style>
/*width*/
.scroll::-webkit-scrollbar {
width:10px;
}
/*thumb*/
.scroll::-webkit-scrollbar-thumb {
background:rgb(206, 236, 236);
border-radius:0px;
}
/*thumb pressed*/
.scroll::-webkit-scrollbar-thumb:active {
border-radius:2px;
}
</style>
</head>
<body>
  <div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navbar-2 dropdowns small-screens w-nav">
    <div class="navbar_container nav_container">
      <a href="../index.html" class="brand w-nav-brand"><img src="../images/katydid-logo-quality.png" loading="lazy" alt="" width="51.5" class="nav_logo"></a>
      <a href="../index.html" class="logo-text w-inline-block">
        <h2 class="heading-6 logo">katydid</h2>
      </a>
      <nav role="navigation" class="nav-menu tablet w-nav-menu">
        <div data-hover="false" data-delay="0" class="dropdown w-dropdown">
          <div class="dropdown-toggle-2 links w-dropdown-toggle">
            <div class="text-block-10">Parsers</div>
          </div>
          <nav class="dropdown-list dropdown-box w-dropdown-list">
            <a href="../parsers/usage.html" target="_blank" class="dropdown-link-3 w-dropdown-link">Usage</a>
            <a href="../parsers/extend.html" target="_blank" class="dropdown-link-3 w-dropdown-link">Extend</a>
          </nav>
        </div>
        <div data-hover="false" data-delay="5" class="dropdown w-dropdown">
          <div class="dropdown-toggle-2 links w-dropdown-toggle">
            <div class="text-block-10">Language</div>
          </div>
          <nav class="dropdown-list-8 w-dropdown-list">
            <a href="../relapse/usage.html" target="_blank" class="dropdown-link-3 w-dropdown-link">Usage</a>
            <a href="../relapse/syntax.html" target="_blank" class="dropdown-link-3 w-dropdown-link">Syntax</a>
            <a href="../relapse/types.html" target="_blank" class="dropdown-link-3 w-dropdown-link">Types</a>
            <a href="../relapse/functions.html" target="_blank" class="dropdown-link-3 w-dropdown-link">Functions</a>
            <a href="../relapse/extend.html" target="_blank" aria-current="page" class="dropdown-link-3 w-dropdown-link w--current">Extend</a>
            <a href="../relapse/speed.html" target="_blank" class="dropdown-link-3 w-dropdown-link">Speed</a>
          </nav>
        </div>
        <div data-hover="false" data-delay="5" class="dropdown w-dropdown">
          <div class="dropdown-toggle-2 links w-dropdown-toggle">
            <div class="text-block-10">Encoders</div>
          </div>
          <nav class="dropdown-list-7 w-dropdown-list">
            <a href="../encoders/usage.html" target="_blank" class="dropdown-link-3 w-dropdown-link">Usage</a>
          </nav>
        </div>
        <div data-hover="false" data-delay="5" class="dropdown w-dropdown">
          <div class="dropdown-toggle-2 links w-dropdown-toggle">
            <div class="text-block-10">Tests</div>
          </div>
          <nav class="dropdown-list-5 w-dropdown-list">
            <a href="../tests/test-suite.html" target="_blank" class="dropdown-link-3 w-dropdown-link">Test Suite</a>
          </nav>
        </div>
        <a href="https://katydid.github.io/play/" target="_blank" class="nav-button-gradient w-inline-block">
          <div class="nav_button-2 tablet">Playground</div>
        </a>
        <a href="https://katydid.github.io/tour/" target="_blank" class="nav-button-gradient guided w-inline-block">
          <div class="nav_button-2 tablet">Guided Tour</div>
        </a>
      </nav>
      <div class="menu-button-2 tablet w-nav-button">
        <div class="w-icon-nav-menu"></div>
      </div>
    </div>
  </div>
  <div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navbar-2 dropdowns desktop w-nav">
    <div class="navbar_container nav_container">
      <a href="../index.html" class="brand w-nav-brand"><img src="../images/katydid-logo-quality.png" loading="lazy" alt="" width="51.5" class="nav_logo"></a>
      <a href="../index.html" class="logo-text w-inline-block">
        <h2 class="heading-6 logo">katydid</h2>
      </a>
      <nav role="navigation" class="nav-menu tablet w-nav-menu">
        <div data-hover="true" data-delay="5" class="dropdown w-dropdown">
          <div class="dropdown-toggle-2 links w-dropdown-toggle">
            <div class="text-block-10">Parsers</div>
          </div>
          <nav class="dropdown-list dropdown-box w-dropdown-list">
            <a href="../parsers/usage.html" target="_blank" class="dropdown-link-4 w-dropdown-link">Usage</a>
            <a href="../parsers/extend.html" target="_blank" class="dropdown-link-4 w-dropdown-link">Extend</a>
          </nav>
        </div>
        <div data-hover="true" data-delay="5" class="dropdown w-dropdown">
          <div class="dropdown-toggle-2 links w-dropdown-toggle">
            <div class="text-block-10">Language</div>
          </div>
          <nav class="dropdown-list-11 w-dropdown-list">
            <a href="../relapse/usage.html" target="_blank" class="dropdown-link-4 w-dropdown-link">Usage</a>
            <a href="../relapse/syntax.html" target="_blank" class="dropdown-link-4 w-dropdown-link">Syntax</a>
            <a href="../relapse/types.html" target="_blank" class="dropdown-link-4 w-dropdown-link">Types</a>
            <a href="../relapse/functions.html" target="_blank" class="dropdown-link-4 w-dropdown-link">Functions</a>
            <a href="../relapse/extend.html" target="_blank" aria-current="page" class="dropdown-link-4 w-dropdown-link w--current">Extend</a>
            <a href="../relapse/speed.html" target="_blank" class="dropdown-link-4 w-dropdown-link">Speed</a>
          </nav>
        </div>
        <div data-hover="true" data-delay="5" class="dropdown w-dropdown">
          <div class="dropdown-toggle-2 links w-dropdown-toggle">
            <div class="text-block-10">Encoders</div>
          </div>
          <nav class="dropdown-list-10 w-dropdown-list">
            <a href="../encoders/usage.html" target="_blank" class="dropdown-link-4 w-dropdown-link">Usage</a>
          </nav>
        </div>
        <div data-hover="true" data-delay="5" class="dropdown w-dropdown">
          <div class="dropdown-toggle-2 links w-dropdown-toggle">
            <div class="text-block-10">Tests</div>
          </div>
          <nav class="dropdown-list-10 w-dropdown-list">
            <a href="../tests/test-suite.html" target="_blank" class="dropdown-link-4 w-dropdown-link">Test Suite</a>
          </nav>
        </div>
        <a href="https://katydid.github.io/play/" target="_blank" class="nav-button-gradient w-inline-block">
          <div class="nav_button-2 tablet">Playground</div>
        </a>
        <a href="https://katydid.github.io/tour/" target="_blank" class="nav-button-gradient guided w-inline-block">
          <div class="nav_button-2 tablet">Guided Tour</div>
        </a>
      </nav>
      <div class="menu-button-2 tablet w-nav-button">
        <div class="w-icon-nav-menu"></div>
      </div>
    </div>
  </div>
  <div class="hero-section">
    <div data-w-id="df75b279-8ad9-3931-8448-5e46db3ee9df" style="opacity:0" class="circle_heading">
      <div class="hero-heading extend">Extend</div>
    </div>
    <div class="intro">
      <p class="paragraph first">Katydid does not allow the specification of new functions in Katydid itself. Katydid is implemented in Go, so adding your own functions will require you to write some Go.</p>
    </div>
  </div>
  <div class="section-margin">
    <div class="my-container heading">
      <div class="w-embed">
        <style>
.gradient {
    -webkit-text-fill-color: transparent;
    -webkit-background-clip: text;
</style>
      </div>
      <h1 class="gradient-heading gradient heading-size-20">Introduction</h1>
      <p class="paragraph">Let’s look at the implementation of the <span class="inline-code">contains</span> function:</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">type</span> contains <span class="res-words">struct</span> { <br>    S           String <br>    Substr      String <br>    hash        <span class="res-words">uint64</span> <br>    hasVariable bool <br>} <br><br><span class="res-words">func</span> (this *contains) Eval() (<span class="res-words">bool</span>, <span class="res-words">error</span>) { <br>    s, err := this.S.Eval() <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        <span class="res-words">return</span> <span class="res-id">false</span>, err <br>    } <br>    subStr, err := this.Substr.Eval() <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        <span class="res-words">return</span> <span class="res-id">false</span>, err <br>    } <br>    <span class="res-words">return</span> strings.Contains(s, subStr), <span class="res-id">nil</span> <br>} <br><br><span class="res-words">func</span> (this *contains) Compare(that Comparable) <span class="res-words">int</span> { <br>    <span class="res-words">if</span> this.Hash() != that.Hash() { <br>        <span class="res-words">if</span> this.Hash() &lt; that.Hash() { <br>            <span class="res-words">return</span> -<span class="int">1</span> <br>        } <br>        <span class="res-words">return</span> <span class="int">1</span> <br>    } <br>    <span class="res-words">if</span> other, ok := that.(*contains); ok { <br>        <span class="res-words">if</span> c := this.S.Compare(other.S); c != <span class="int">0</span> { <br>            <span class="res-words">return</span> c <br>        } <br>        <span class="res-words">if</span> c := this.Substr.Compare(other.Substr); c != <span class="int">0</span> { <br>            return c <br>        } <br>        <span class="res-words">return</span> <span class="int">0</span> <br>    } <br>    <span class="res-words">return</span> strings.Compare(this.String(), that.String()) <br>} <br><br><span class="res-words">func</span> (this *contains) HasVariable() <span class="res-words">bool</span> { <br>    <span class="res-words">return</span> this.hasVariable <br>} <br><br><span class="res-words">func</span> (this *contains) String() <span class="res-words">string</span> { <br>    <span class="res-words">return</span> <span class="strings">&quot;contains(&quot;</span> + this.S.String() + <span class="strings">&quot;,&quot;</span> +this.Substr.String() + <span class="strings">&quot;)&quot;</span> <br>} <br><br><span class="res-words">func</span> (this *contains) Hash() <span class="res-words">uint64</span> { <br>    <span class="res-words">return</span> this.hash <br>} <br><br><span class="res-words">func</span> Contains(s, sub String) Bool { <br>    <span class="res-words">return</span> TrimBool(&amp;contains{ <br>        S: s, <br>        Substr: sub, <br>        hash: Hash(<span class="strings">&quot;contains&quot;</span>, s, sub), <br>        hasVariable: s.HasVariable() || sub.HasVariable(), <br>    }) <br>} <br><br><span class="res-words">func</span> init() { <br>    Register(<span class="strings">&quot;contains&quot;</span>, Contains) <br>}<br></div>
    </div>
    <div class="my-container">
      <p class="paragraph">Our function is defined as a <span class="inline-code">struct</span>, which has to implement the following <span class="inline-code">Func</span> interface:</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">type</span> Func <span class="res-words">interface</span> { <br>    Comparable <br>    HasVariable() <span class="res-words">bool</span> <br>} <br><br><span class="res-words">type</span> Comparable <span class="res-words">interface</span> { <br>    Compare(Comparable) <span class="res-words">int</span> <br>    Hashable <br>    Stringer <br>} <br><br><span class="res-words">type</span> Hashable <span class="res-words">interface</span> { <br>    Hash() <span class="res-words">uint64</span> <br>} <br><br><span class="res-words">type</span> Stringer <span class="res-words">interface</span> { <br>    String() <span class="res-words">string</span> <br>}<br></div>
    </div>
    <div class="my-container">
      <p class="paragraph">Each function must also have an <span class="inline-code">Eval</span> method which returns a value of type: <span class="inline-code">string</span>, <span class="inline-code">[]byte</span>, <span class="inline-code">int64</span>, <span class="inline-code">unit64</span>, <span class="inline-code">bool</span> or <span class="inline-code">float</span> and an <span class="inline-code">error</span>.</p>
      <p class="paragraph par-second-line">Our example is a function of type <span class="inline-code">Bool</span> so it implements an <span class="inline-code">Eval</span> method that returns a <span class="inline-code">bool</span> and an <span class="inline-code">error</span> and also the <span class="inline-code">Func</span> interface.</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">type</span> Bool <span class="res-words">interface</span> { <br>    Func <br>    Eval() (<span class="res-words">bool</span>, <span class="res-words">error</span>) <br>}<br></div>
    </div>
    <div class="my-container">
      <p class="paragraph">Finally, the function is registered with its name and a constructor.<br><br>The constructor is responsible for:<br>- placing the parameters in the <span class="inline-code">struct</span>, for later evaluation, <br>- simplification of the function (optional), <br>- trimming: calculating functions at compile time, if possible, and <br>- pre-calculating a hash of the function and whether the function’s parameters has a variable.<br><br>Each parameter is of type <span class="inline-code">Func</span>. For our example, <span class="inline-code">contains</span>, both parameters are of type <span class="inline-code">String</span>, which is an interface which inherits the <span class="inline-code">Func</span> type.</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">type</span> String <span class="res-words">interface</span> { <br>    Func <br>    Eval() (<span class="res-words">string</span>, <span class="res-words">error</span>) <br>}<br></div>
    </div>
    <div class="my-container">
      <p class="paragraph">Simplification is only done in rare cases like for the functions: <span class="inline-code">and</span>, <span class="inline-code">or</span>, and <span class="inline-code">not</span>, so you won’t need to worry about that.<br><br>Trimming tries to evaluate the function at compile time and replace it with a constant. It can only trim pure functions, whose parameters also don’t have variables. This is why we calculate the <span class="inline-code">hasVariable</span> value, by checking whether any of the parameters have a variable. If no parameter has a variable and our function is pure then it can be trimmed to a constant and should return <span class="inline-code">false</span> from its <span class="inline-code">HasVariable</span> method. There is a <span class="inline-code">Trim&lt;Type&gt;</span> function for each type.<br><br>Pre-calculating a hash is done to speed up comparisons. Comparisons are done as part of simplifications and minimizes the state space required by relapse. These comparisons are quite expensive for large queries and so we use hashes to speed them up. This is also why we want to calculate the hash only once. The <span class="inline-code">Hash</span> helper function expects the function’s name and its input parameters.</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">func</span> Hash(name <span class="res-words">string</span>, hs ...Hashable) <span class="res-words">uint64</span><br></div>
    </div>
    <div class="my-container">
      <p class="paragraph">Now that we have defined the constructor, we can take a look at the other methods. The <span class="inline-code">Hash</span> and <span class="inline-code">HasVariable</span> methods simply return the pre-calculated values. These values are pre-calculated for efficiency reasons.<br><br>The <span class="inline-code">String</span> method should return the string representation of the function in its relapse syntax. Parsing this string as an expression should result in the same function.<br><br>The <span class="inline-code">Compare</span> method is used for simplification of patterns and functions. We first compare the <span class="inline-code">Hash</span> values, because if they differ then we don’t need to do a deep comparison. If the hash values are the same, then we need to look deeper. The most likely case is that the function types are the same. We can then compare the function’s input parameters. If they are all the same, then we should return <span class="inline-code">0</span> for equal. If the types and hashes differ, then our last and most expensive resort is to create a string representation and compare these strings. This is really expensive for large expressions and that is why we first try the hash and deep comparisons.<br><br>The <span class="inline-code">Eval</span> method evaluates each parameter and then using the resulting values does the actual function calculation and returns the value.<br><br>All function types are defined <a href="https://github.com/katydid/katydid/blob/master/relapse/funcs/types.go" target="_blank" class="inline-link">here</a>.<br><br>Finally the <span class="inline-code">init</span> function registers the <span class="inline-code">contains</span> structure as a Katydid function. The first parameter is the function name. This can differ from the structure name, which is especially useful when we want to do function overloading.</p>
    </div>
    <div class="my-container heading-less-pad">
      <h1 class="gradient-heading gradient heading-size-21">Testing</h1>
      <p class="paragraph">Adding a user function is quite advanced behaviour and it is recommended that each function should be tested. Here is an example test for the contains function:</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">import</span> ( <br>    <span class="strings">&quot;strings&quot;</span> <br>    <span class="strings">&quot;testing&quot;</span> <br><br>    <span class="strings">&quot;github.com/katydid/katydid/parser/debug&quot;</span> <br>    <span class="strings">&quot;github.com/katydid/katydid/relapse/ast&quot;</span> <br>    c <span class="strings">&quot;github.com/katydid/katydid/relapse/combinator&quot;</span> <br>    <span class="strings">&quot;github.com/katydid/katydid/relapse/compose&quot;</span> <br>) <br><br><span class="res-words">func</span> TestContains(t *testing.T) { <br>    expr := ast.NewFunction(<span class="strings">&quot;contains&quot;</span>, c.StringVar(),c.StringConst(<span class="strings">&quot;TheStreet&quot;</span>)) <br>    b, err := compose.NewBool(expr) <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        t.Fatal(err) <br>    } <br>    f, err := compose.NewBoolFunc(b) <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        t.Fatal(err) <br>    } <br>    r, err := f.Eval(debug.NewStringValue(<span class="strings">&quot;TheStreet&quot;</span>)) <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        t.Fatal(err) <br>    } <br>    <span class="res-words">if</span> r != <span class="res-id">true</span> { <br>        t.Fatalf(<span class="strings">&quot;expected true&quot;</span>) <br>    } <br>    r, err = f.Eval(debug.NewStringValue(<span class="strings">&quot;ThatStreet&quot;</span>)) <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        t.Fatal(err) <br>    } <br>    <span class="res-words">if</span> r != <span class="res-id">false</span> { <br>        t.Fatalf(<span class="strings">&quot;expected false&quot;</span>) <br>    } <br>}<br></div>
    </div>
    <div class="my-container">
      <p class="paragraph">This will test that registration occurred correctly.</p>
    </div>
    <div class="my-container heading-less-pad">
      <h1 class="gradient-heading gradient heading-size">Handling Errors</h1>
      <p class="paragraph">Some functions are inevitably going to have possible runtime errors. Here we see an <span class="inline-code">elem</span> function which returns the element in the list at the specified index.</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">type</span> elemDoubles <span class="res-words">struct</span> { <br>    List        Doubles <br>    Index       Int <br>    hash        <span class="res-words">uint64</span> <br>    hasVariable <span class="res-words">bool</span> <br>} <br><br><span class="res-words">func</span> (this *elemDoubles) Eval() (<span class="res-words">float64</span>, <span class="res-words">error</span>) { <br>    list, err := this.List.Eval() <br><span class="res-words">    if</span> err != <span class="res-id">nil</span> { <br><span class="res-words">        return</span> <span class="int">0</span>, err <br>    } <br>    index64, err := this.Index.Eval() <br><span class="res-words">    if</span> err != <span class="res-id">nil</span> { <br><span class="res-words">        return</span> <span class="int">0</span>, err <br>    } <br>    index := int(index64) <br><span class="res-words">    if</span> <span class="res-id">len</span>(list) == <span class="int">0</span> { <br><span class="res-words">        return</span> <span class="int">0</span>, NewRangeCheckErr(index, <span class="res-id">len</span>(list)) <br>    } <br><span class="res-words">    if</span> index &lt; <span class="int">0</span> { <br>    index = index % <span class="res-id">len</span>(list) <br>    } <br><span class="res-words">    if</span> <span class="res-id">len</span>(list) &lt;= index { <br><span class="res-words">        return</span> <span class="int">0</span>, NewRangeCheckErr(index, <span class="res-id">len</span>(list)) <br>    } <br><span class="res-words">    return</span> list[index], <span class="res-id">nil</span> <br>} <br><br>...<br></div>
    </div>
    <div class="my-container">
      <p class="paragraph">When we see that the function is trying to access an element outside of the list range, we simply return a plain Go error.</p>
    </div>
    <div class="my-container heading-less-pad">
      <h1 class="gradient-heading gradient heading-size-22">Handling Errors in Boolean Functions</h1>
      <p class="paragraph">The not function does not return errors. This means that when it receives an error, it interprets it as false and returns true.</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">func</span> (this *not) Eval() (<span class="res-words">bool</span>, <span class="res-words">error</span>) { <br>    b, err := this.V1.Eval() <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> || !b { <br>        <span class="res-words">return</span> <span class="res-id">true</span>, <span class="res-id">nil</span> <br>    } <br>    <span class="res-words">return</span> !b, <span class="res-id">nil</span> <br>}<br></div>
    </div>
    <div class="my-container">
      <p class="paragraph">This means that functions that are opposites of each other need to take this into account. Here we can see the greater or equal function returning false rather than an error.</p>
      <div class="code-block">
        <div class="code-block-text"><span class="res-words">func</span> (this *intGE) Eval() (<span class="res-words">bool</span>, <span class="res-words">error</span>) { <br>    v1, err := this.V1.Eval() <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        <span class="res-words">return</span> <span class="res-id">false</span>, <span class="res-id">nil</span> <br>    } <br>    v2, err := this.V2.Eval() <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        <span class="res-words">return</span> <span class="res-id">false</span>, <span class="res-id">nil</span> <br>    } <br>    <span class="res-words">return</span> v1 &gt;= v2, <span class="res-id">nil</span> <br>}<br></div>
      </div>
    </div>
    <div class="my-container">
      <p class="paragraph">This means that the less than function needs to return true given an error.</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">func</span> (this *intLt) Eval() (<span class="res-words">bool</span>, <span class="res-words">error</span>) { <br>    v1, err := this.V1.Eval() <br><span class="res-words">    if</span> err != <span class="res-id">nil</span> { <br><span class="res-words">        return</span> <span class="res-id">true</span>, <span class="res-id">nil</span> <br>    } <br>    v2, err := this.V2.Eval() <br><span class="res-words">    if</span> err != <span class="res-id">nil</span> { <br><span class="res-words">        return</span> <span class="res-id">true</span>, <span class="res-id">nil</span> <br>    } <br><span class="res-words">    return</span> v1 &lt; v2, <span class="res-id">nil</span> <br>}<br></div>
    </div>
    <div class="my-container heading-less-pad">
      <h1 class="gradient-heading gradient heading-size23">Constants and Compile Time Evaluations</h1>
      <p class="paragraph">There are some functions for which you want to calculate some things only once, for example a regular expression matcher compiles the pattern only once. Let&#x27;s look at Katydid’s built in regular expression function.</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">import</span> ( <br>    <span class="strings">&quot;regexp&quot;</span> <br>) <br><br><span class="res-words">func</span> Regex(expr ConstString, input String) (Bool, <span class="res-words">error</span>) { <br>    <span class="res-words">if</span> expr.HasVariable() { <br>        <span class="res-words">return</span> <span class="res-id">nil</span>, fmt.Errorf(<span class="strings">&quot;regex requires a constant expression as its first<br>        parameter, but it has a variable parameter&quot;</span>) <br>    } <br>    e, err := expr.Eval() <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        <span class="res-words">return</span> <span class="res-id">nil</span>, err <br>    } <br>    r, err := regexp.Compile(e) <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        <span class="res-words">return</span> <span class="res-id">nil</span>, err <br>    } <br>    <span class="res-words">return</span> TrimBool(&amp;regex{ <br>        r: r, <br>        S: input, <br>        expr: e, <br>        hash: Hash(<span class="strings">&quot;regex&quot;</span>, expr, input), <br>        hasVariable: input.HasVariable(), <br>    }), <span class="res-id">nil</span> <br>} <br><br><span class="res-words">type</span> regex <span class="res-words">struct</span> { <br>    r           *regexp.Regexp <br>    expr        <span class="res-words">string</span> <br>    S           String <br>    hash        <span class="res-words">uint64</span> <br>    hasVariable <span class="res-words">bool</span> <br>} <br><br><span class="res-words">func</span> (this *regex) Eval() (<span class="res-words">bool</span>, <span class="res-words">error</span>) { <br>    s, err := this.S.Eval() <br>    <span class="res-words">if</span> err != <span class="res-id">nil</span> { <br>        <span class="res-words">return</span> <span class="res-id">false</span>, err <br>    } <br>    <span class="res-words">return</span> this.r.MatchString(s), <span class="res-id">nil</span> <br>} <br><br>...<br></div>
    </div>
    <div class="my-container">
      <p class="paragraph">We pre-calculate <span class="inline-code">r</span> in the constructor as a field member of the structure. Our <span class="inline-code">Eval</span> method can then use the compiled regular expression to match the bytes.<br><br>We first check that <span class="inline-code">expr</span> does not have a variable, since we want to evaluate the expression at compile time. In the constructor we specify that this parameter is a <span class="inline-code">ConstString</span>. This is just a <span class="inline-code">String</span>, but it makes sure that the generated documentation mentions that this function requires the parameter to be calculated at compile time.</p>
    </div>
    <div class="my-container heading-less-pad">
      <h1 class="gradient-heading gradient heading-size-24">Variables</h1>
      <p class="paragraph">Variables are values that possibly change with every execution, typically these are fields, but they can also include functions whose values change over time, database versions, etc.<br><br>If your function does not evaluate to the same value given the same parameters every time, you should declare it as variable. Simply return <span class="inline-code">true</span> from the <span class="inline-code">HasVariable</span> method.<br><br>Lets look at the <span class="inline-code">now</span> function:</p>
    </div>
    <div class="code-block">
      <div class="code-block-text"><span class="res-words">import</span> <span class="strings">&quot;time&quot;</span> <br><br><span class="res-words">func</span> Now() Int { <br><span class="res-words">    return</span> &amp;now{} <br>} <br><br><span class="res-words">type</span> now <span class="res-words">struct</span>{} <br><br><span class="res-words">func</span> (this *now) Eval() (<span class="res-words">int64</span>, <span class="res-words">error</span>) { <br>    <span class="res-words">return</span> time.Now().UnixNano(), <span class="res-id">nil</span> <br>} <br><br><span class="res-words">func</span> (this *now) Hash() <span class="res-words">uint64</span> { <br>    <span class="res-words">return</span> Hash(<span class="strings">&quot;now&quot;</span>) <br>} <br><br><span class="res-words">func</span> (this *now) Compare(that Comparable) <span class="res-words">int</span> { <br>    <span class="res-words">if</span> this.Hash() != that.Hash() { <br>        <span class="res-words">if</span> this.Hash() &lt; that.Hash() { <br>            <span class="res-words">return</span> <span class="int">-1</span> <br>        } <br>        <span class="res-words">return</span> <span class="int">1</span> <br>    } <br>    <span class="res-words">if</span> _, ok := that.(*now); ok { <br>        <span class="res-words">return</span> <span class="int">0</span> <br>    } <br>    <span class="res-words">return</span> strings.Compare(this.String(), that.String()) <br>} <br><br><span class="res-words">func</span> (this *now) String() string { <br>    <span class="res-words">return</span> <span class="int">&quot;now()&quot;</span> <br>} <br><br><span class="res-words">func</span> (this *now) HasVariable() <span class="res-words">bool</span> { <span class="res-words">return</span> true } <br><br><span class="res-words">func</span> init() { <br>    Register(<span class="int">&quot;now&quot;</span>, Now) <br>}<br></div>
    </div>
    <div class="my-container last">
      <p class="paragraph">Obviously this function’s value will be different almost every time that it is evaluated.</p>
      <p class="paragraph par-second-line">We make sure that <span class="inline-code">HasVariable</span> returns <span class="inline-code">true</span>, so that this function won’t be trimmed and will return a different value for each evaluation.</p>
    </div>
  </div>
  <div class="footer-section">
    <div class="footer-div">
      <div class="w-layout-grid footer-grid">
        <div class="footer-col">
          <div class="image-div"><img src="../images/katydid-logo-quality.png" loading="lazy" width="51.5" alt="" class="image-31"></div>
          <div class="text-block-21">katydid</div>
        </div>
        <div id="w-node-abfc4d3e-97fb-1ab1-409a-ead63d40dead-3d40dea5" class="footer-col">
          <h1 class="grid-head">About</h1>
          <div class="grid-text">
            <a href="https://github.com/katydid" target="_blank" class="footer-link">Project</a>
          </div>
          <div class="grid-text">
            <a href="http://katydid.github.io/play" target="_blank" class="footer-link">Playground</a>
          </div>
        </div>
        <div id="w-node-abfc4d3e-97fb-1ab1-409a-ead63d40deb4-3d40dea5" class="footer-col">
          <h1 class="grid-head">Contribute</h1>
          <div class="grid-text">
            <a href="mailto:awalterschulze@gmail.com" class="footer-link">Contact</a>
          </div>
          <div class="grid-text">
            <a href="http://github.com/katydid" target="_blank" class="footer-link">Github</a>
          </div>
          <div class="grid-text">
            <a href="#" target="_blank" class="footer-link">More</a>
          </div>
        </div>
        <div id="w-node-abfc4d3e-97fb-1ab1-409a-ead63d40debd-3d40dea5" class="footer-col">
          <h1 class="grid-head">Implement</h1>
          <div class="grid-text">
            <a href="http://github.com/katydid/katydid" target="_blank" class="footer-link">Go</a>
          </div>
          <div class="grid-text">
            <a href="https://github.com/katydid/katydid-haskell" target="_blank" class="footer-link">Haskell</a>
          </div>
          <div class="grid-text">
            <a href="http://github.com/katydid/proofs" target="_blank" class="footer-link">Lean</a>
          </div>
        </div>
        <div id="w-node-abfc4d3e-97fb-1ab1-409a-ead63d40dec6-3d40dea5" class="footer-col">
          <h1 class="grid-head">Social</h1>
          <div class="grid-text">
            <a href="https://github.com/awalterschulze" target="_blank" class="footer-link">Github</a>
          </div>
          <div class="grid-text">
            <a href="https://www.linkedin.com/in/awalterschulze/" target="_blank" class="footer-link">LinkedIn</a>
          </div>
          <div class="grid-text">
            <a href="https://twitter.com/awalterschulze" target="_blank" class="footer-link">Twitter</a>
          </div>
          <div class="grid-text">
            <a href="https://www.youtube.com/c/awalterschulze" target="_blank" class="footer-link">Youtube</a>
          </div>
        </div>
        <div id="w-node-abfc4d3e-97fb-1ab1-409a-ead63d40ded1-3d40dea5" class="footer-col">
          <h1 class="grid-head">Help</h1>
          <div class="grid-text">
            <a href="http://katydid.github.io/tour" target="_blank" class="footer-link">Tour</a>
          </div>
          <div class="grid-text">
            <a href="http://github.com/katydid/katydid/issues" target="_blank" class="footer-link">Issues</a>
          </div>
          <div class="grid-text">
            <a href="../relapse/syntax.html" target="_blank" class="footer-link">Syntax</a>
          </div>
        </div>
      </div>
      <div class="text-block-3">© Copyright 2014 - 2022 Walter Schulze</div>
    </div>
  </div>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=62fa1b7c943e1b195a14776d" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="../js/webflow.js" type="text/javascript"></script>
</body>
</html>